{
  "description": "Shared missed-call flow with voicemail + callbacks (headerless-friendly)",
  "states": [
    {
      "name": "Trigger",
      "type": "trigger",
      "transitions": [
        {
          "event": "incomingMessage"
        },
        {
          "next": "LookupClient",
          "event": "incomingCall"
        },
        {
          "event": "incomingConversationMessage"
        },
        {
          "event": "incomingRequest"
        },
        {
          "event": "incomingParent"
        }
      ],
      "properties": {
        "offset": {
          "x": -150,
          "y": -420
        }
      }
    },
    {
      "name": "LookupClient",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "RouteByForward",
          "event": "success"
        },
        {
          "next": "Hangup",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": -10,
          "y": -130
        },
        "method": "GET",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "url": "{{API_BASE_URL}}/twilio/studio/lookup?called={{trigger.call.To}}&from={{trigger.call.From}}&fwd={{trigger.call.ForwardedFrom}}&token={{STUDIO_BEARER}}",
        "timeout": 10
      }
    },
    {
      "name": "DialClient",
      "type": "connect-call-to",
      "transitions": [
        {
          "next": "CheckDialStatus",
          "event": "callCompleted"
        },
        {
          "next": "Hangup",
          "event": "hangup"
        }
      ],
      "properties": {
        "offset": {
          "x": 330,
          "y": 260
        },
        "caller_id": "{{trigger.call.To}}",
        "record": false,
        "noun": "number",
        "to": "{{widgets.LookupClient.parsed.forward_to}}",
        "timeout": 20
      }
    },
    {
      "name": "CheckDialStatus",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "CheckConsentExists",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "unanswered/busy/failed/canceled",
              "arguments": [
                "{{widgets.DialClient.DialCallStatus}}"
              ],
              "type": "matches_any_of",
              "value": "no-answer,busy,failed,canceled"
            }
          ]
        },
        {
          "next": "Hangup",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.DialClient.DialCallStatus}}",
        "offset": {
          "x": 640,
          "y": -420
        }
      }
    },
    {
      "name": "AskConsent",
      "type": "gather-input-on-call",
      "transitions": [
        {
          "next": "SplitConsent",
          "event": "keypress"
        },
        {
          "next": "RecordVoicemail",
          "event": "timeout"
        },
        {
          "next": "Hangup",
          "event": "hangup"
        }
      ],
      "properties": {
        "voice": "Polly.Danielle-Generative",
        "number_of_digits": 1,
        "offset": {
          "x": 1400,
          "y": -410
        },
        "loop": 1,
        "say": "{{widgets.LookupClient.parsed.greeting_message}} {{widgets.LookupClient.parsed.consent_message}}",
        "language": "en-US",
        "stop_gather": true,
        "gather_language": "en-US",
        "speech_model": "default",
        "timeout": 5
      }
    },
    {
      "name": "SplitConsent",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "PostConsent",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "digit-1",
              "arguments": [
                "{{widgets.AskConsent.Digits}}"
              ],
              "type": "equal_to",
              "value": "1"
            }
          ]
        },
        {
          "next": "RecordVoicemail",
          "event": "noMatch"
        }
      ],
      "properties": {
        "input": "{{widgets.AskConsent.Digits}}",
        "offset": {
          "x": 1410,
          "y": -100
        }
      }
    },
    {
      "name": "PostConsent",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "RecordVoicemail",
          "event": "success"
        },
        {
          "next": "RecordVoicemail",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1620,
          "y": 270
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"from\":\"{{trigger.call.From}}\",\"to\":\"{{trigger.call.To}}\",\"client_id\":\"{{widgets.LookupClient.parsed.client_id}}\",\"call_sid\":\"{{trigger.call.CallSid}}\",\"source\":\"ivr-dtmf\",\"digit\":\"{{widgets.AskConsent.Digits}}\"}",
        "url": "{{API_BASE_URL}}/twilio/studio/consent?token={{STUDIO_BEARER}}",
        "timeout": 10
      }
    },
    {
      "name": "RecordVoicemail",
      "type": "record-voicemail",
      "transitions": [
        {
          "next": "PostVoicemail",
          "event": "recordingComplete"
        },
        {
          "next": "NoVoicemail",
          "event": "noAudio"
        },
        {
          "next": "PostVoicemail",
          "event": "hangup"
        }
      ],
      "properties": {
        "offset": {
          "x": 790,
          "y": 680
        },
        "max_length": 120
      }
    },
    {
      "name": "PostVoicemail",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "Hangup",
          "event": "success"
        },
        {
          "next": "Hangup",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 1580,
          "y": 670
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"recording_url\":\"{{widgets.RecordVoicemail.RecordingUrl}}\",\"from\":\"{{trigger.call.From}}\",\"to\":\"{{trigger.call.To}}\",\"client_id\":\"{{widgets.LookupClient.parsed.client_id}}\",\"call_sid\":\"{{trigger.call.CallSid}}\"}",
        "url": "{{API_BASE_URL}}/twilio/studio/voicemail?token={{STUDIO_BEARER}}",
        "timeout": 10
      }
    },
    {
      "name": "NoVoicemail",
      "type": "make-http-request",
      "transitions": [
        {
          "next": "Hangup",
          "event": "success"
        },
        {
          "next": "Hangup",
          "event": "failed"
        }
      ],
      "properties": {
        "offset": {
          "x": 710,
          "y": 1060
        },
        "method": "POST",
        "content_type": "application/json",
        "add_twilio_auth": false,
        "body": "{\"from\":\"{{trigger.call.From}}\",\"to\":\"{{trigger.call.To}}\",\"client_id\":\"{{widgets.LookupClient.parsed.client_id}}\",\"call_sid\":\"{{trigger.call.CallSid}}\"}",
        "url": "{{API_BASE_URL}}/twilio/studio/no-voicemail?token={{STUDIO_BEARER}}",
        "timeout": 10
      }
    },
    {
      "name": "Hangup",
      "type": "add-twiml-redirect",
      "transitions": [],
      "properties": {
        "offset": {
          "x": 1420,
          "y": 1090
        },
        "method": "GET",
        "url": "https://twimlets.com/echo?Twiml=%3CResponse%3E%3CHangup%2F%3E%3C%2FResponse%3E",
        "timeout": "0"
      }
    },
    {
      "name": "CheckConsentExists",
      "type": "split-based-on",
      "transitions": [
        {
          "event": "noMatch"
        },
        {
          "next": "AskConsent",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to False",
              "arguments": [
                "{{widgets.LookupClient.parsed.consent_exists}}"
              ],
              "type": "equal_to",
              "value": "False"
            }
          ]
        },
        {
          "next": "GreetingMessage",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to True",
              "arguments": [
                "{{widgets.LookupClient.parsed.consent_exists}}"
              ],
              "type": "equal_to",
              "value": "True"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.LookupClient.parsed.consent_exists}}",
        "offset": {
          "x": 910,
          "y": -170
        }
      }
    },
    {
      "name": "GreetingMessage",
      "type": "say-play",
      "transitions": [
        {
          "next": "RecordVoicemail",
          "event": "audioComplete"
        }
      ],
      "properties": {
        "voice": "Polly.Danielle-Generative",
        "offset": {
          "x": 980,
          "y": 130
        },
        "loop": 1,
        "say": "{{widgets.LookupClient.parsed.greeting_message}}",
        "language": "en-US"
      }
    },
    {
      "name": "RouteByForward",
      "type": "split-based-on",
      "transitions": [
        {
          "next": "DialClient",
          "event": "noMatch"
        },
        {
          "next": "CheckConsentExists",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to True",
              "arguments": [
                "{{widgets.LookupClient.parsed.skip_dial}}"
              ],
              "type": "equal_to",
              "value": "true"
            }
          ]
        },
        {
          "next": "DialClient",
          "event": "match",
          "conditions": [
            {
              "friendly_name": "If value equal_to false",
              "arguments": [
                "{{widgets.LookupClient.parsed.skip_dial}}"
              ],
              "type": "equal_to",
              "value": "false"
            }
          ]
        }
      ],
      "properties": {
        "input": "{{widgets.LookupClient.parsed.skip_dial}}",
        "offset": {
          "x": 370,
          "y": -140
        }
      }
    }
  ],
  "initial_state": "Trigger",
  "flags": {
    "allow_concurrent_calls": true
  }
}